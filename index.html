<html>
  <head>
    <title>AiR Violin</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script _src="/aframe.min.js"></script>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://gftruj.github.io/hand.tracking.controls.extras/dist/aframe-hand-tracking-controls-extras.js"></script>

    <script src="/air-violin-component.js"></script>
  </head>
  <body>
    <a-scene
      shadow="type: pcfsoft"
      renderer="colorManagement:true; toneMapping:ACESFilmic;"
      air-violin="side: left; leftHand: #leftHandControls; rightHand: #rightHandControls; modeText: #modeText; violin: #violin; bow: #bow; camera: #camera"
    >
      <a-assets>
        <a-asset-item
          id="violinModel"
          src="https://cdn.glitch.global/3eac8fa3-7e87-4e7d-b367-f094d90e92b4/violinModel.glb?v=1671645297984"
        ></a-asset-item>
        <a-asset-item
          id="bowModel"
          src="https://cdn.glitch.global/3eac8fa3-7e87-4e7d-b367-f094d90e92b4/bowModel.glb?v=1671650879127"
        ></a-asset-item>
      </a-assets>

      <a-camera position="0 1.6 0" id="camera">
        <a-entity id="violin" position="0 -0.21 -0.13" _scale="8 8 8">
          <a-entity id="violinModelEntity" gltf-model="#violinModel"></a-entity>

          <a-entity
            class="guides"
            position="0 0.027 -0.459"
            rotation="81.739 0 0"
          >
            <a-sphere
              class="origin"
              visible="false"
              color="red"
              radius="0.002"
            ></a-sphere>

            <a-entity position="-0.008 0 0">
              <a-entity rotation="0.207 -0.215 1.651">
                <a-sphere data-finger color="white" radius="0.004"></a-sphere>
                <a-cylinder
                  data-string
                  color="yellow"
                  radius="0.002"
                  height="0.334"
                  position="0 0.167 0"
                ></a-cylinder>
              </a-entity>
            </a-entity>

            <a-entity position="-0.002 0 0">
              <a-entity rotation="-0.286 -0.092 0.609">
                <a-sphere data-finger color="white" radius="0.004"></a-sphere>
                <a-cylinder
                  data-string
                  color="green"
                  radius="0.002"
                  height="0.334"
                  position="0 0.167 0"
                ></a-cylinder>
              </a-entity>
            </a-entity>

            <a-entity position="0.004 0 0">
              <a-entity rotation="-0.133 0.049 -0.329">
                <a-sphere data-finger color="white" radius="0.004"></a-sphere>
                <a-cylinder
                  data-string
                  color="blue"
                  radius="0.002"
                  height="0.334"
                  position="0 0.167 0"
                ></a-cylinder>
              </a-entity>
            </a-entity>

            <a-entity position="0.009 0 0">
              <a-entity rotation="0.434 0.161 -1.108">
                <a-sphere data-finger color="white" radius="0.004"></a-sphere>
                <a-cylinder
                  data-string
                  color="purple"
                  radius="0.002"
                  height="0.334"
                  position="0 0.167 0"
                ></a-cylinder>
              </a-entity>
            </a-entity>

            <a-entity data-notes position="0 0.329 -0.014" rotation="-90 0 0">
              <a-entity data-note position="-0.024 0 0" scale="0.05 0.05 0.05">
                <a-text
                  value="G"
                  color="black"
                  material="shader: flat;"
                  position="0 0 0"
                  align="center"
                ></a-text>
                <a-entity scale="1 1 1">
                  <a-plane
                    height="0.3"
                    opacity="0.7"
                    width="0.3"
                    color="yellow"
                    material="shader: flat;"
                    position="0 0 -0.001"
                  ></a-plane>
                </a-entity>
              </a-entity>

              <a-entity
                data-note
                position="-0.008 0.003 0"
                scale="0.05 0.05 0.05"
              >
                <a-text
                  value="D"
                  color="black"
                  material="shader: flat;"
                  position="0 0 0"
                  align="center"
                ></a-text>
                <a-entity scale="1 1 1">
                  <a-plane
                    height="0.3"
                    opacity="0.7"
                    width="0.3"
                    color="limegreen"
                    material="shader: flat;"
                    position="0 0 -0.001"
                  ></a-plane>
                </a-entity>
              </a-entity>

              <a-entity
                data-note
                position="0.008 0.003 0"
                scale="0.05 0.05 0.05"
              >
                <a-text
                  value="A"
                  color="black"
                  material="shader: flat;"
                  position="0 0 0"
                  align="center"
                ></a-text>
                <a-entity scale="1 1 1">
                  <a-plane
                    height="0.3"
                    opacity="0.7"
                    width="0.3"
                    color="#00e1ff"
                    material="shader: flat;"
                    position="0 0 -0.001"
                  ></a-plane>
                </a-entity>
              </a-entity>

              <a-entity data-note position="0.024 0 0" scale="0.05 0.05 0.05">
                <a-text
                  value="E"
                  color="black"
                  material="shader: flat;"
                  position="0 0 0"
                  align="center"
                ></a-text>
                <a-entity scale="1 1 1">
                  <a-plane
                    height="0.3"
                    opacity="0.7"
                    width="0.3"
                    color="#c72eff"
                    material="shader: flat;"
                    position="0 0 -0.001"
                  ></a-plane>
                </a-entity>
              </a-entity>
            </a-entity>

            <a-entity data-frets>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.0227 0"
                rotation="0 0 90"
              ></a-cylinder>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.0416 0"
                rotation="0 0 90"
              ></a-cylinder>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.05638 0"
                rotation="0 0 90"
              ></a-cylinder>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.0723 0"
                rotation="0 0 90"
              ></a-cylinder>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.08465 0"
                rotation="0 0 90"
              ></a-cylinder>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.10065 0"
                rotation="0 0 90"
              ></a-cylinder>
              <a-cylinder
                data-fret
                radius="0.002"
                height="0.04"
                position="0 0.1152 0"
                rotation="0 0 90"
              ></a-cylinder>
            </a-entity>
          </a-entity>
        </a-entity>

        <a-entity position="0 0 -0.4" id="hud">
          <a-entity position="-0.25 0.12 0" scale="0.2 0.2 0.2">
            <a-text
              id="modeText"
              value=""
              color="black"
              material="shader: flat;"
              position="0 0 0"
              align="left"
            ></a-text>
            <a-entity scale="3 1 1">
              <a-plane
                height="0.3"
                opacity="0.7"
                width="0.3"
                color="white"
                material="shader: flat;"
                position="0.15 0 -0.001"
              ></a-plane>
            </a-entity>
          </a-entity>
        </a-entity>
      </a-camera>

      <a-entity
        id="leftHandControls"
        hand-tracking-controls="hand: left;"
        hand-tracking-extras
      ></a-entity>
      <a-entity
        id="rightHandControls"
        hand-tracking-controls="hand: right;"
        hand-tracking-extras
      >
        <a-entity visible="false" id="bow" _scale="8 8 8">
          <a-entity id="bowEntity" gltf-model="#bowModel"></a-entity>
        </a-entity>
      </a-entity>
    </a-scene>
  </body>

  <script>
    const audioContext = Tone.context.rawContext._nativeAudioContext;
    audioContext.addEventListener("statechange", () => {
      console.log("audioContext state:", audioContext.state);
      if (audioContext.state !== "running") {
        document.addEventListener("click", () => audioContext.resume(), {
          once: true,
        });
      }
    });
    audioContext.dispatchEvent(new Event("statechange"));
  </script>
</html>
